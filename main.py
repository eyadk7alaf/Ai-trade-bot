import asyncio
import time
import os
import sqlite3
import pandas as pd
import yfinance as yf
import schedule

from aiogram import Bot, Dispatcher, types, F, BaseMiddleware
from aiogram.filters import Command
from aiogram.types import ReplyKeyboardMarkup, KeyboardButton
from aiogram.fsm.storage.memory import MemoryStorage
from aiogram.fsm.context import FSMContext
from aiogram.fsm.state import StatesGroup, State
# ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„ØµØ­ÙŠØ­ Ù„Ù€ DefaultBotProperties
from aiogram.client.default import DefaultBotProperties
from typing import Callable, Dict, Any, Awaitable

# =============== Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø¨ÙˆØª ÙˆØ§Ù„Ù…ØªØºÙŠØ±Ø§Øª ===============
# Ù†Ø¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¨ÙŠØ¦ÙŠØ© (Environment Variables)
BOT_TOKEN = os.getenv("TELEGRAM_BOT_TOKEN")
ADMIN_ID_STR = os.getenv("ADMIN_ID", "0") # ÙŠØ¬Ø¨ ØªØ¹ÙŠÙŠÙ† Ù‚ÙŠÙ…Ø© Ø§Ù„Ø§Ø¯Ù…Ù† ÙÙŠ Railway
TRADE_SYMBOL = os.getenv("TRADE_SYMBOL", "AAPL") # ÙŠÙ…ÙƒÙ† ØªØºÙŠÙŠØ±Ù‡ ÙÙŠ Railway

try:
    ADMIN_ID = int(ADMIN_ID_STR)
except ValueError:
    print("âš ï¸ Ù„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯ ADMIN_ID Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­. ØªÙ… ØªØ¹ÙŠÙŠÙ†Ù‡ Ø¥Ù„Ù‰ 0.")
    ADMIN_ID = 0 

if not BOT_TOKEN:
    raise ValueError("ğŸš« Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù…ØªØºÙŠØ± Ø§Ù„Ø¨ÙŠØ¦Ø© TELEGRAM_BOT_TOKEN. ÙŠØ±Ø¬Ù‰ Ø¶Ø¨Ø·Ù‡.")

# âœ… Ø§Ù„Ø¥ØµÙ„Ø§Ø­: Ø§Ø³ØªØ®Ø¯Ø§Ù… default=DefaultBotProperties Ù„ØªØ­Ø¯ÙŠØ¯ parse_mode
bot = Bot(token=BOT_TOKEN, 
          default=DefaultBotProperties(parse_mode="HTML")) 
          
dp = Dispatcher(storage=MemoryStorage())

# =============== Ù‚Ø§Ø¹Ø¯Ø© Ø¨ÙŠØ§Ù†Ø§Øª SQLite Ø§Ù„Ø¯Ø§Ø¦Ù…Ø© ===============
DB_NAME = 'alpha_trade_ai.db'
CONN = None

def init_db():
    """ØªÙ‡ÙŠØ¦Ø© Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„."""
    global CONN
    # ÙŠØªÙ… ÙØªØ­ Ø§Ù„Ø§ØªØµØ§Ù„ ÙÙŠ ÙƒÙ„ Ø¹Ù…Ù„ÙŠØ© ØªØ´ØºÙŠÙ„ Ø¹Ù„Ù‰ Railway
    CONN = sqlite3.connect(DB_NAME)
    cursor = CONN.cursor()
    cursor.execute("""
        CREATE TABLE IF NOT EXISTS users (
            user_id INTEGER PRIMARY KEY,
            username TEXT,
            joined_at REAL,
            is_banned INTEGER DEFAULT 0
        )
    """)
    CONN.commit()

def add_user(user_id, username):
    """Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯ Ø£Ùˆ ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§ØªÙ‡."""
    cursor = CONN.cursor()
    cursor.execute("""
        INSERT OR IGNORE INTO users (user_id, username, joined_at) 
        VALUES (?, ?, ?)
    """, (user_id, username, time.time()))
    CONN.commit()

def get_total_users():
    """Ø¬Ù„Ø¨ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†."""
    cursor = CONN.cursor()
    cursor.execute("SELECT COUNT(*) FROM users")
    return cursor.fetchone()[0]

def is_banned(user_id):
    """Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø¸Ø±."""
    cursor = CONN.cursor()
    cursor.execute("SELECT is_banned FROM users WHERE user_id = ?", (user_id,))
    result = cursor.fetchone()
    return result is not None and result[0] == 1

def update_ban_status(user_id, status):
    """ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø¸Ø± (1 Ù„Ù„Ø­Ø¸Ø±ØŒ 0 Ù„Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø­Ø¸Ø±)."""
    cursor = CONN.cursor()
    cursor.execute("INSERT OR IGNORE INTO users (user_id) VALUES (?)", (user_id,))
    cursor.execute("UPDATE users SET is_banned = ? WHERE user_id = ?", (status, user_id))
    CONN.commit()
    
def get_all_users_ids():
    """Ø¬Ù„Ø¨ Ø¬Ù…ÙŠØ¹ Ù…Ø¹Ø±ÙØ§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† ÙˆØ­Ø§Ù„Ø© Ø§Ù„Ø­Ø¸Ø±."""
    cursor = CONN.cursor()
    cursor.execute("SELECT user_id, is_banned FROM users")
    return cursor.fetchall()

# =============== Ø¨Ø±Ù…Ø¬ÙŠØ© ÙˆØ³ÙŠØ·Ø© Ù„Ù„Ø­Ø¸Ø± (Middleware) - ØªÙ… Ø§Ù„Ø¥ØµÙ„Ø§Ø­ âœ… ===============
class BanMiddleware(BaseMiddleware):
    async def __call__(
        self,
        handler: Callable[[types.TelegramObject, Dict[str, Any]], Awaitable[Any]],
        event: types.TelegramObject,
        data: Dict[str, Any],
    ) -> Any:
        # Ø§Ù„ÙˆØµÙˆÙ„ Ø§Ù„Ø¢Ù…Ù† Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù…Ø±Ø³Ù„
        user = data.get('event_from_user')
        
        if user is None:
            return await handler(event, data)

        user_id = user.id
        
        # Ø§Ø³ØªØ«Ù†Ø§Ø¡ Ø§Ù„Ø£Ø¯Ù…Ù†
        if user_id == ADMIN_ID:
            return await handler(event, data)

        # Ù…Ù†Ø¹ Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø­Ø¸ÙˆØ±Ù‹Ø§
        if is_banned(user_id):
            if isinstance(event, types.Message):
                try:
                    await event.answer("ğŸš« Ø­Ø³Ø§Ø¨Ùƒ Ù…Ø­Ø¸ÙˆØ± Ù…Ù† Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¨ÙˆØª.", reply_markup=types.ReplyKeyboardRemove())
                except:
                    pass
            return 

        return await handler(event, data)


# =============== ÙˆØ¸Ø§Ø¦Ù Ø§Ù„ØªØ¯Ø§ÙˆÙ„ ÙˆØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (yfinance Ùˆ pandas) ===============

def fetch_latest_price(symbol: str) -> str:
    """Ø¬Ù„Ø¨ Ø¢Ø®Ø± Ø³Ø¹Ø± Ø¥ØºÙ„Ø§Ù‚ Ù„Ø±Ù…Ø² ØªØ¯Ø§ÙˆÙ„ Ù…Ø­Ø¯Ø¯."""
    try:
        ticker = yf.Ticker(symbol)
        # Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ø£Ù‚Ø±Ø¨ Ø´Ù…Ø¹Ø© (Ø¹Ø§Ø¯Ø© 1 Ø¯Ù‚ÙŠÙ‚Ø©)
        data = ticker.history(period="1d", interval="1m")
        
        if data.empty:
            return f"Ù„Ø§ ØªØªÙˆÙØ± Ø¨ÙŠØ§Ù†Ø§Øª Ø­Ø¯ÙŠØ«Ø© Ù„Ø±Ù…Ø² Ø§Ù„ØªØ¯Ø§ÙˆÙ„: {symbol}."

        latest_price = data['Close'].iloc[-1]
        latest_time = data.index[-1].strftime('%Y-%m-%d %H:%M:%S')
        
        return f"ğŸ“Š Ø¢Ø®Ø± Ø³Ø¹Ø± Ù„Ù€ <b>{symbol}</b>:\nØ§Ù„Ø³Ø¹Ø±: ${latest_price:,.2f}\nØ§Ù„ÙˆÙ‚Øª: {latest_time} UTC"
        
    except Exception as e:
        return f"âŒ ÙØ´Ù„ ÙÙŠ Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ¯Ø§ÙˆÙ„ Ù„Ù€ {symbol}. ØªØ£ÙƒØ¯ Ù…Ù† ØµØ­Ø© Ø§Ù„Ø±Ù…Ø²: {e}"

async def send_daily_trade_signal():
    """ÙˆØ¸ÙŠÙØ© Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø§Ø±Ø© ØªØ¯Ø§ÙˆÙ„ Ù…Ø¬Ø¯ÙˆÙ„Ø© Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†."""
    price_info = fetch_latest_price(TRADE_SYMBOL)
    
    trade_msg = f"""
ğŸš¨ <b>Ø¥Ø´Ø§Ø±Ø© ØªØ¯Ø§ÙˆÙ„ ÙŠÙˆÙ…ÙŠØ© (Ø¢Ù„ÙŠØ©)</b> ğŸš¨
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ“ˆ <b>Ø±Ù…Ø² Ø§Ù„ØªØ¯Ø§ÙˆÙ„:</b> {TRADE_SYMBOL}
{price_info}
ğŸ’¡ <b>ØªØ­Ù„ÙŠÙ„:</b> Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ù…Ø¤Ø´Ø±Ø§ØªÙ†Ø§ØŒ Ù‡Ù†Ø§Ùƒ ÙØ±ØµØ© Ø´Ø±Ø§Ø¡ Ù…Ø­ØªÙ…Ù„Ø©.
âš ï¸ <b>ØªØ°ÙƒÙŠØ±:</b> ØªØ¯Ø§ÙˆÙ„ Ø¨Ù…Ø³Ø¤ÙˆÙ„ÙŠØ©.
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
"""
    sent = 0
    all_users = get_all_users_ids()
    
    for uid, is_banned_status in all_users:
        if is_banned_status == 0 and uid != ADMIN_ID:
            try:
                await bot.send_message(uid, trade_msg)
                sent += 1
            except Exception:
                pass
                
    if ADMIN_ID != 0:
        try:
            await bot.send_message(ADMIN_ID, f"ğŸ“¢ ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¥Ø´Ø§Ø±Ø© Ø§Ù„ØªØ¯Ø§ÙˆÙ„ÙŠØ© Ø§Ù„Ø¢Ù„ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­ Ø¥Ù„Ù‰ {sent} Ù…Ø³ØªØ®Ø¯Ù….\n{price_info}")
        except Exception:
            pass

# =============== Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…/Ø§Ù„Ø£Ø¯Ù…Ù† Ùˆ FSM ===============
# ØªÙ… Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ØµØ­Ø© Ø¨Ù†Ø§Ø¡ ReplyKeyboardMarkup (Ø­Ù„ Ù…Ø´ÙƒÙ„Ø© Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©)
def user_menu():
    return ReplyKeyboardMarkup(
        keyboard=[
            [KeyboardButton(text="ğŸ“ˆ Ø³Ø¹Ø± Ø§Ù„Ø³ÙˆÙ‚ Ø§Ù„Ø­Ø§Ù„ÙŠ"), KeyboardButton(text="ğŸ“Š Ø¬Ø¯ÙˆÙ„ Ø§Ù„ÙŠÙˆÙ…")],
            [KeyboardButton(text="ğŸ’¬ ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø§Ù„Ø¯Ø¹Ù…"), KeyboardButton(text="â„¹ï¸ Ø¹Ù† AlphaTradeAI")]
        ],
        resize_keyboard=True
    )

def admin_menu():
    return ReplyKeyboardMarkup(
        keyboard=[
            [KeyboardButton(text="ğŸ“¢ Ø±Ø³Ø§Ù„Ø© Ù„ÙƒÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†"), KeyboardButton(text="ğŸ’¹ Ø¥Ø±Ø³Ø§Ù„ ØµÙÙ‚Ø© ÙŠØ¯ÙˆÙŠØ©")],
            [KeyboardButton(text="ğŸš« Ø­Ø¸Ø± Ù…Ø³ØªØ®Ø¯Ù…"), KeyboardButton(text="âœ… Ø¥Ù„ØºØ§Ø¡ Ø­Ø¸Ø± Ù…Ø³ØªØ®Ø¯Ù…")],
            [KeyboardButton(text="ğŸ‘¥ Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†"), KeyboardButton(text="ğŸ”™ Ø¹ÙˆØ¯Ø© Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…")]
        ],
        resize_keyboard=True
    )

class AdminStates(StatesGroup):
    waiting_broadcast = State()
    waiting_trade = State()
    waiting_ban = State()
    waiting_unban = State()

# =============== Ù…Ø¹Ø§Ù„Ø¬Ø§Øª Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ ÙˆØ§Ù„Ø£ÙˆØ§Ù…Ø± ===============

@dp.message(Command("start"))
async def cmd_start(msg: types.Message):
    user_id = msg.from_user.id
    username = msg.from_user.username or "Ù…Ø³ØªØ®Ø¯Ù…"
    
    add_user(user_id, username)

    welcome_msg = f"""
ğŸ¤– <b>Ù…Ø±Ø­Ø¨Ù‹Ø§ Ø¨Ùƒ ÙÙŠ AlphaTradeAI!</b>
ğŸš€ Ù†Ø¸Ø§Ù… Ø°ÙƒÙŠ ÙŠØªØ§Ø¨Ø¹ Ø§Ù„Ø³ÙˆÙ‚ ({TRADE_SYMBOL}).
Ø§Ø®ØªØ± Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© ğŸ‘‡
"""
    await msg.reply(welcome_msg, reply_markup=user_menu())

# Ø£ÙˆØ§Ù…Ø± Ø§Ù„Ø£Ø¯Ù…Ù†
@dp.message(Command("admin"))
async def admin_panel(msg: types.Message):
    if msg.from_user.id != ADMIN_ID:
        await msg.reply("ğŸš« Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ….")
        return
    await msg.reply("ğŸ›ï¸ Ù…Ø±Ø­Ø¨Ù‹Ø§ Ø¨Ùƒ ÙÙŠ Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ø£Ø¯Ù…Ù†!", reply_markup=admin_menu())

@dp.message(F.text == "ğŸš« Ø­Ø¸Ø± Ù…Ø³ØªØ®Ø¯Ù…")
async def ban_user_start(msg: types.Message, state: FSMContext):
    if msg.from_user.id != ADMIN_ID: return
    await msg.reply("ğŸ“› Ø£Ø±Ø³Ù„ ID Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù…Ø±Ø§Ø¯ Ø­Ø¸Ø±Ù‡:")
    await state.set_state(AdminStates.waiting_ban)

@dp.message(AdminStates.waiting_ban)
async def process_ban(msg: types.Message, state: FSMContext):
    if msg.from_user.id != ADMIN_ID: return
    try:
        uid = int(msg.text)
        update_ban_status(uid, 1) 
        await msg.reply(f"ğŸš« ØªÙ… Ø­Ø¸Ø± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… {uid} Ø¨Ù†Ø¬Ø§Ø­.")
        if uid != ADMIN_ID:
             try:
                 await bot.send_message(uid, "ğŸš« ØªÙ… Ø­Ø¸Ø± Ø­Ø³Ø§Ø¨Ùƒ Ù…Ù† Ù‚Ø¨Ù„ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©.")
             except:
                 pass
    except Exception as e:
        await msg.reply(f"âŒ ID ØºÙŠØ± ØµØ§Ù„Ø­ Ø£Ùˆ Ø­Ø¯Ø« Ø®Ø·Ø£: {e}")
    await state.clear()
    await msg.answer("ğŸ›ï¸ Ø§Ù„Ø¹ÙˆØ¯Ø© Ø¥Ù„Ù‰ Ù„ÙˆØ­Ø© Ø§Ù„Ø£Ø¯Ù…Ù†.", reply_markup=admin_menu())

@dp.message(F.text == "âœ… Ø¥Ù„ØºØ§Ø¡ Ø­Ø¸Ø± Ù…Ø³ØªØ®Ø¯Ù…")
async def unban_user_start(msg: types.Message, state: FSMContext):
    if msg.from_user.id != ADMIN_ID: return
    await msg.reply("â™»ï¸ Ø£Ø±Ø³Ù„ ID Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„Ø¥Ù„ØºØ§Ø¡ Ø­Ø¸Ø±Ù‡:")
    await state.set_state(AdminStates.waiting_unban)

@dp.message(AdminStates.waiting_unban)
async def process_unban(msg: types.Message, state: FSMContext):
    if msg.from_user.id != ADMIN_ID: return
    try:
        uid = int(msg.text)
        update_ban_status(uid, 0) # 0 Ù„Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø­Ø¸Ø±
        await msg.reply(f"âœ… ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø­Ø¸Ø± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… {uid} Ø¨Ù†Ø¬Ø§Ø­.")
    except Exception as e:
        await msg.reply(f"âŒ ID ØºÙŠØ± ØµØ§Ù„Ø­ Ø£Ùˆ Ø­Ø¯Ø« Ø®Ø·Ø£: {e}")
    await state.clear()
    await msg.answer("ğŸ›ï¸ Ø§Ù„Ø¹ÙˆØ¯Ø© Ø¥Ù„Ù‰ Ù„ÙˆØ­Ø© Ø§Ù„Ø£Ø¯Ù…Ù†.", reply_markup=admin_menu())

@dp.message(F.text == "ğŸ“¢ Ø±Ø³Ø§Ù„Ø© Ù„ÙƒÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†")
async def send_broadcast_start(msg: types.Message, state: FSMContext):
    if msg.from_user.id != ADMIN_ID: return
    await msg.reply("ğŸ“ Ø£Ø±Ø³Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªÙŠ ØªØ±ÙŠØ¯ Ø¥Ø±Ø³Ø§Ù„Ù‡Ø§ Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†:")
    await state.set_state(AdminStates.waiting_broadcast)

@dp.message(AdminStates.waiting_broadcast)
async def process_broadcast(msg: types.Message, state: FSMContext):
    if msg.from_user.id != ADMIN_ID: return
    sent = 0
    failed = 0
    all_users = get_all_users_ids()
    
    for uid, is_banned_status in all_users:
        if is_banned_status == 0: # Ø¥Ø±Ø³Ø§Ù„ ÙÙ‚Ø· Ù„ØºÙŠØ± Ø§Ù„Ù…Ø­Ø¸ÙˆØ±ÙŠÙ†
            try:
                await bot.send_message(uid, msg.text)
                sent += 1
            except Exception:
                failed += 1
            
    await msg.reply(f"âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø¥Ù„Ù‰ {sent} Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…Ø­Ø¸ÙˆØ±.\nâŒ ÙØ´Ù„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø¥Ù„Ù‰ {failed} Ù…Ø³ØªØ®Ø¯Ù….")
    await state.clear()
    await msg.answer("ğŸ›ï¸ Ø§Ù„Ø¹ÙˆØ¯Ø© Ø¥Ù„Ù‰ Ù„ÙˆØ­Ø© Ø§Ù„Ø£Ø¯Ù…Ù†.", reply_markup=admin_menu())
    
# Ø£ÙˆØ§Ù…Ø± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
@dp.message(F.text == "ğŸ“ˆ Ø³Ø¹Ø± Ø§Ù„Ø³ÙˆÙ‚ Ø§Ù„Ø­Ø§Ù„ÙŠ")
async def get_current_price(msg: types.Message):
    price_info = fetch_latest_price(TRADE_SYMBOL)
    await msg.reply(price_info)
    
@dp.message(F.text.in_(["ğŸ“Š Ø¬Ø¯ÙˆÙ„ Ø§Ù„ÙŠÙˆÙ…", "ğŸ’¬ ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø§Ù„Ø¯Ø¹Ù…", "â„¹ï¸ Ø¹Ù† AlphaTradeAI"]))
async def handle_user_actions(msg: types.Message):
    if msg.text == "ğŸ“Š Ø¬Ø¯ÙˆÙ„ Ø§Ù„ÙŠÙˆÙ…":
        await msg.reply("ğŸ—“ï¸ ÙŠØªÙ… Ø¹Ø±Ø¶ Ø¢Ø®Ø± Ø¥Ø´Ø§Ø±Ø© ØªØ¯Ø§ÙˆÙ„ Ø¢Ù„ÙŠØ©:")
        await send_daily_trade_signal() 
    elif msg.text == "ğŸ’¬ ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø§Ù„Ø¯Ø¹Ù…":
        await msg.reply(f"ğŸ“ ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ù…Ø¨Ø§Ø´Ø±Ø© Ø¹Ø¨Ø± @Admin_Username Ø£Ùˆ Ø§Ù„Ø¥Ø¨Ù„Ø§Øº Ø¹Ù† Ù…Ø´ÙƒÙ„Ø©.")
    elif msg.text == "â„¹ï¸ Ø¹Ù† AlphaTradeAI":
        await msg.reply("ğŸŒŸ Ù†Ø­Ù† Ù†Ù‚Ø¯Ù… ØªØ­Ù„ÙŠÙ„Ø§Øª ØªØ¯Ø§ÙˆÙ„ ØªØ¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ Ù„Ù…Ø³Ø§Ø¹Ø¯ØªÙƒ ÙÙŠ Ø§ØªØ®Ø§Ø° Ù‚Ø±Ø§Ø±Ø§Øª Ø£ÙØ¶Ù„ ÙÙŠ Ø§Ù„Ø³ÙˆÙ‚.")


# =============== Ø­Ù„Ù‚Ø© Ø§Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„Ù…Ø¬Ø¯ÙˆÙ„Ø© (Schedule Runner) ===============
async def scheduler_runner():
    """ØªØ´ØºÙŠÙ„ Ø§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„Ù…Ø¬Ø¯ÙˆÙ„Ø© Ø¨Ø´ÙƒÙ„ ØºÙŠØ± Ù…ØªØ²Ø§Ù…Ù†."""
    # Ø¬Ø¯ÙˆÙ„ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¥Ø´Ø§Ø±Ø© ÙƒÙ„ 60 Ø¯Ù‚ÙŠÙ‚Ø©
    schedule.every(60).minutes.do(lambda: asyncio.create_task(send_daily_trade_signal()))
    
    while True:
        try:
            schedule.run_pending()
        except Exception as e:
            print(f"Error in scheduler: {e}")
        await asyncio.sleep(1) 

# =============== ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¨ÙˆØª (Main Function) ===============
async def main():
    # 1. ØªÙ‡ÙŠØ¦Ø© Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    init_db()
    
    # 2. ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù€ Middleware
    dp.update.outer_middleware(BanMiddleware())
    
    print("âœ… Bot is running and ready for polling.")
    print(f"ğŸ‘¤ Admin ID: {ADMIN_ID} | Trade Symbol: {TRADE_SYMBOL}")
    
    # 3. ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¨ÙˆØª ÙˆØ­Ù„Ù‚Ø© Ø§Ù„Ø¬Ø¯ÙˆÙ„Ø© ÙÙŠ Ù†ÙØ³ Ø§Ù„ÙˆÙ‚Øª
    await asyncio.gather(
        dp.start_polling(bot),
        scheduler_runner()
    )

if __name__ == "__main__":
    try:
        asyncio.run(main())
    except KeyboardInterrupt:
        print("Bot stopped manually.")
    except Exception as e:
        print(f"An error occurred during runtime: {e}")
